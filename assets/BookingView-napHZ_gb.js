import{f as F,u as O,r as v,g as $,p as z,c as p,w as o,a,o as c,b as l,d as f,k as G,t as L,l as T,F as P,q as R,m as U,i as B}from"./index-B8VNrrUr.js";const q={key:1,class:"d-flex flex-wrap ga-2"},E={key:2,class:"text-center text-grey py-8"},K={__name:"BookingView",setup(W){const u=F(),N=O(),{user:H,userName:A}=N,n=v(new Date),g=v(null),x=v([]),k=v(!1),V=$(()=>{if(!g.value||!n.value)return[];const t=n.value.getDay(),e=g.value.schedule[t];if(!e||!e.active)return[];const s=[],w=30;let r=new Date(n.value);const[m,y]=e.start.split(":");r.setHours(m,y,0,0);const _=new Date(n.value),[S,h]=e.end.split(":");for(_.setHours(S,h,0,0);r<_;){const d=new Date(r),b=x.value.some(D=>new Date(D.dateTime).getTime()===d.getTime());s.push({time:d.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}),dateTime:d.toISOString(),isBooked:b}),r.setMinutes(r.getMinutes()+w)}return s});async function C(t){k.value=!0;try{const[e,s]=await Promise.all([B.get("/availability"),B.get(`/bookings?dateTime_like=${t.toISOString().slice(0,10)}`)]);g.value=e.data[0],x.value=s.data}catch(e){u.showSnackbar("讀取資料失敗","error"),console.error("API 請求失敗:",e)}finally{k.value=!1}}z(n,t=>{t&&C(t)},{immediate:!0});async function I(t){if(!(t.isBooked||!confirm(`您確定要預約 ${new Date(t.dateTime).toLocaleString()} 的時段嗎？`))){u.setGlobalLoading(!0);try{const s={userId:H.id,userName:A,dateTime:t.dateTime};await B.post("/bookings",s),u.showSnackbar("預約成功！","success"),await C(n.value)}catch{u.showSnackbar("預約失敗，請稍後再試","error")}finally{u.setGlobalLoading(!1)}}}function M(t){const e=new Date;return e.setHours(0,0,0,0),t>=e}return(t,e)=>{const s=a("v-card-title"),w=a("v-date-picker"),r=a("v-card"),m=a("v-col"),y=a("v-card-subtitle"),_=a("v-skeleton-loader"),S=a("v-chip"),h=a("v-icon"),d=a("v-card-text"),b=a("v-row"),D=a("v-container");return c(),p(D,null,{default:o(()=>[l(b,null,{default:o(()=>[l(m,{md:"5",cols:"12"},{default:o(()=>[l(r,{rounded:"lg"},{default:o(()=>[l(s,null,{default:o(()=>e[1]||(e[1]=[f("1. 選擇日期",-1)])),_:1,__:[1]}),l(w,{modelValue:n.value,"onUpdate:modelValue":e[0]||(e[0]=i=>n.value=i),"full-width":"",color:"primary","allowed-dates":M},null,8,["modelValue"])]),_:1})]),_:1}),l(m,{md:"7",cols:"12"},{default:o(()=>[l(r,{rounded:"lg",class:"fill-height"},{default:o(()=>[l(s,null,{default:o(()=>e[2]||(e[2]=[f("2. 選擇時段",-1)])),_:1,__:[2]}),n.value?(c(),p(y,{key:0},{default:o(()=>[f(L(n.value.toLocaleDateString()),1)]),_:1})):G("",!0),l(d,null,{default:o(()=>[k.value?(c(),p(_,{key:0,type:"chip@12"})):V.value.length>0?(c(),T("div",q,[(c(!0),T(P,null,R(V.value,i=>(c(),p(S,{key:i.time,color:i.isBooked?"":"primary",disabled:i.isBooked,onClick:j=>I(i),size:"large",label:""},{default:o(()=>[f(L(i.time),1)]),_:2},1032,["color","disabled","onClick"]))),128))])):(c(),T("div",E,[l(h,{icon:"mdi-calendar-remove",size:"48"}),e[3]||(e[3]=U("p",{class:"mt-2"},"本日無可預約時段",-1))]))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}}};export{K as default};
